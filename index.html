<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>做T成本助手</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#F0F3F5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <style>
        :root {
            --up-color: #e74c3c;
            --down-color: #27ae60;
            --primary: #2c3e50;
            --bg: #F0F3F5; /* 统一背景色 */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, sans-serif;
            background-color: var(--bg);
            margin: 0;
            /* 适配刘海屏，上方留出状态栏高度 */
            padding: calc(env(safe-area-inset-top) + 5px) 12px calc(env(safe-area-inset-bottom) + 12px) 12px;
            overflow-x: hidden;
        }

        .container { width: 100%; max-width: 500px; margin: 0 auto; }

        /* 看板不再延伸至状态栏，而是作为独立的卡片 */
        .dashboard {
            display: flex;
            background: var(--primary);
            color: white;
            padding: 18px 10px;
            border-radius: 12px;
            margin-bottom: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(44, 62, 80, 0.2);
        }
        .dash-item { flex: 1; }
        .dash-label { font-size: 0.75rem; opacity: 0.8; margin-bottom: 5px; }
        .dash-value { font-size: 1.25rem; font-weight: bold; }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .mode-switch {
            display: flex; align-items: center; justify-content: center;
            padding: 12px; border-radius: 8px; margin-bottom: 15px;
            transition: all 0.3s; border: 1px solid #ddd;
            background: #fff;
        }
        .mode-stock { border-color: #ffa39e; background: #fff1f0; }
        .mode-etf { border-color: #91d5ff; background: #e6f7ff; }
        .mode-switch input { width: 20px; height: 20px; margin-right: 10px; }

        .flex-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
        .field { flex: 1; min-width: calc(50% - 5px); }
        .field-full { min-width: 100%; }

        label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 5px; font-weight: bold; }
        input {
            width: 100%; padding: 12px; border: 1px solid #eee;
            border-radius: 8px; font-size: 1rem; outline: none; background: #f9f9f9;
        }
        input:focus { border-color: var(--primary); background: #fff; }

        .btn-add {
            width: 100%; padding: 16px; background: var(--primary);
            color: white; border: none; border-radius: 8px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
        }

        .record-item {
            padding: 12px 0; border-bottom: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .text-up { color: var(--up-color); font-weight: bold; }
        .text-down { color: var(--down-color); font-weight: bold; }
        .clear-btn { width: 100%; text-align: center; padding: 15px; color: #999; font-size: 0.8rem; background: none; border: none; text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <div class="dashboard">
        <div class="dash-item" style="border-right: 1px solid rgba(255,255,255,0.2)">
            <div class="dash-label">摊薄成本</div>
            <div id="dispCost" class="dash-value">0.0000</div>
        </div>
        <div class="dash-item">
            <div class="dash-label">累计盈亏</div>
            <div id="dispProfit" class="dash-value">0.00</div>
        </div>
    </div>

    <div class="card">
        <div id="modeStatus" class="mode-switch mode-stock">
            <input type="checkbox" id="isETF" onchange="updateUI()">
            <strong>启用 ETF 模式</strong>
        </div>
        <div class="flex-grid">
            <div class="field"><label>初始成本</label><input type="number" id="baseCost" step="0.001"></div>
            <div class="field"><label>持仓股数</label><input type="number" id="baseQty" step="100"></div>
        </div>
        <div class="flex-grid">
            <div class="field"><label>佣金%</label><input type="number" id="feeRate" value="0.025"></div>
            <div class="field tax-related"><label>过户费%</label><input type="number" id="transferRate" value="0.001"></div>
            <div class="field field-full tax-related"><label>卖出印花税%</label><input type="number" id="taxRate" value="0.05"></div>
        </div>
    </div>

    <div class="card" style="border-top: 4px solid var(--up-color);">
        <div class="flex-grid">
            <div class="field"><label>买入价格</label><input type="number" id="buyPrice" step="0.001"></div>
            <div class="field"><label>卖出价格</label><input type="number" id="sellPrice" step="0.001"></div>
            <div class="field field-full"><label>成交数量</label><input type="number" id="tradeQty" step="100"></div>
        </div>
        <button class="btn-add" onclick="calculate()">计算并更新</button>
    </div>

    <div class="card">
        <div id="recordList"></div>
        <button class="clear-btn" onclick="reset()">重置数据</button>
    </div>
</div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); });
    }

    let data = JSON.parse(localStorage.getItem('stock_t_pwa_v4')) || { records: [], cost: 0, qty: 0, profit: 0 };

    function updateUI() {
        const isETF = document.getElementById('isETF').checked;
        document.getElementById('modeStatus').className = isETF ? "mode-switch mode-etf" : "mode-switch mode-stock";
        document.querySelectorAll('.tax-related').forEach(el => el.style.display = isETF ? 'none' : 'block');
    }

    function calculate() {
        const bc = parseFloat(document.getElementById('baseCost').value);
        const bq = parseFloat(document.getElementById('baseQty').value);
        const bp = parseFloat(document.getElementById('buyPrice').value);
        const sp = parseFloat(document.getElementById('sellPrice').value);
        const tq = parseFloat(document.getElementById('tradeQty').value);
        const isETF = document.getElementById('isETF').checked;
        const fR = parseFloat(document.getElementById('feeRate').value)/100;
        const tR = parseFloat(document.getElementById('taxRate').value)/100;
        const trR = parseFloat(document.getElementById('transferRate').value)/100;

        if(!bc || !bq || !bp || !sp || !tq) return alert("请完整填写");
        if(data.records.length === 0) { data.cost = bc; data.qty = bq; }

        const bFee = Math.max(isETF ? 0 : 5, bp * tq * fR);
        const sFee = Math.max(isETF ? 0 : 5, sp * tq * fR);
        const tax = isETF ? 0 : (sp * tq * tR);
        const trans = isETF ? 0 : (bp + sp) * tq * trR;
        
        const net = (sp - bp) * tq - (bFee + sFee + tax + trans);
        data.profit += net;
        data.cost = (data.cost * data.qty - net) / data.qty;

        data.records.unshift({
            msg: `B:${bp} / S:${sp} (${tq})`,
            p: net.toFixed(2),
            c: data.cost.toFixed(4),
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        });

        localStorage.setItem('stock_t_pwa_v4', JSON.stringify(data));
        render();
        document.getElementById('buyPrice').value = '';
        document.getElementById('sellPrice').value = '';
    }

    function render() {
        document.getElementById('dispCost').innerText = data.cost ? data.cost.toFixed(4) : "0.0000";
        document.getElementById('dispProfit').innerText = data.profit.toFixed(2);
        document.getElementById('dispProfit').className = 'dash-value ' + (data.profit >= 0 ? 'text-up' : 'text-down');
        document.getElementById('recordList').innerHTML = data.records.map(r => `
            <div class="record-item">
                <div><div>${r.msg}</div><div style="font-size:0.7rem;color:#999">${r.time} · 成本:${r.c}</div></div>
                <div class="${parseFloat(r.p)>=0?'text-up':'text-down'}">${r.p}</div>
            </div>`).join('') || '<div style="text-align:center;color:#ccc;padding:20px;">暂无交易数据</div>';
    }

    function reset() { if(confirm("确定清除？")) { localStorage.removeItem('stock_t_pwa_v4'); location.reload(); } }
    updateUI(); render();
</script>
</body>
</html